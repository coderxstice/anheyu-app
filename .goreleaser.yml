# .goreleaser.yml - Anheyu App Release Configuration

# GoReleaser é…ç½®ç‰ˆæœ¬
version: 2

# é¡¹ç›®é…ç½®
project_name: anheyu-app

# ç¯å¢ƒå˜é‡
env:
  - GO111MODULE=on
  - CGO_ENABLED=0

# æ„å»ºå‰é’©å­ - æ„å»ºå‰ç«¯èµ„æº
before:
  hooks:
    - go mod tidy
    - go mod download

# æ„å»ºé…ç½®
builds:
  - id: anheyu-app
    main: ./main.go
    binary: anheyu-app

    # ç‰ˆæœ¬ä¿¡æ¯æ³¨å…¥
    ldflags:
      - -s -w
      - -X 'github.com/anzhiyu-c/anheyu-app/internal/pkg/version.Version={{.Version}}'
      - -X 'github.com/anzhiyu-c/anheyu-app/internal/pkg/version.Commit={{.ShortCommit}}'
      - -X 'github.com/anzhiyu-c/anheyu-app/internal/pkg/version.Date={{.Date}}'

    # æ„å»ºç›®æ ‡
    goos:
      - linux
      - windows
      - darwin

    goarch:
      - amd64
      - arm64

    # ç‰¹å®šå¹³å°é…ç½®
    goamd64:
      - v1

    # å¿½ç•¥ç‰¹å®šç»„åˆ
    ignore:
      - goos: windows
        goarch: arm64

    # è¾“å‡ºæ–‡ä»¶åæ¨¡æ¿
    hooks:
      post:
        - cmd: echo "Built {{ .Path }}"

# å½’æ¡£é…ç½®
archives:
  - id: anheyu-app-archives
    # GoReleaser v2 è‡ªåŠ¨å…³è”æ‰€æœ‰æ„å»ºï¼Œæ— éœ€æŒ‡å®š builds

    # å½’æ¡£æ–‡ä»¶åæ¨¡æ¿
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}"

    # æ–‡ä»¶æ ¼å¼ (v2 æœ€æ–°è¯­æ³•)
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip

    # åŒ…å«çš„æ–‡ä»¶ (ç°åœ¨å¯ä»¥ä½¿ç”¨ç®€å•globï¼Œå› ä¸ºæœ‰.gitkeepæ–‡ä»¶)
    files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/**/*

# Checksum é…ç½®
checksum:
  name_template: "{{ .ProjectName }}_{{ .Version }}_checksums.txt"
  algorithm: sha256

# å¿«ç…§é…ç½®
snapshot:
  # GoReleaser v2 ä½¿ç”¨ version_template æ›¿ä»£ name_template
  version_template: "{{ .Version }}-SNAPSHOT-{{ .ShortCommit }}"

# æ›´æ–°æ—¥å¿—é…ç½®
changelog:
  sort: asc
  use: github

  filters:
    exclude:
      - "^docs\\([\\w]+\\):"
      - "^test\\([\\w]+\\):"
      - "^ci\\([\\w]+\\):"
      - "^build\\([\\w]+\\):"
      - "^style\\([\\w]+\\):"
      - "^refactor\\([\\w]+\\):"
      - "Merge pull request"
      - "Merge branch"

  groups:
    - title: "ğŸš€ Features"
      regexp: "^feat\\([\\w]+\\): .*$"
      order: 0
    - title: "ğŸ› Bug Fixes"
      regexp: "^fix\\([\\w]+\\): .*$"
      order: 1
    - title: "ğŸ“š Documentation"
      regexp: "^docs\\([\\w]+\\): .*$"
      order: 2
    - title: "âš¡ Performance"
      regexp: "^perf\\([\\w]+\\): .*$"
      order: 3
    - title: "ğŸ”§ Maintenance"
      regexp: "^(chore|refactor|style)\\([\\w]+\\): .*$"
      order: 999

# Docker é•œåƒé…ç½® - ä½¿ç”¨ä¿®å¤åçš„ dockers æ ¼å¼
dockers:
  - id: anheyu-app-docker
    goos: linux
    goarch: amd64

    image_templates:
      - 'anheyu/anheyu-backend:{{ if eq (substr .Tag 0 1) "v" }}{{ substr .Tag 1 }}{{ else }}{{ .Tag }}{{ end }}'
      - "anheyu/anheyu-backend:latest"

    dockerfile: Dockerfile
    use: buildx

    build_flag_templates:
      - "--platform=linux/amd64"
      - "--pull"
      - "--build-arg=VERSION={{ .Version }}"
      - "--build-arg=COMMIT={{ .ShortCommit }}"
      - "--build-arg=BUILD_DATE={{ .Date }}"
      - "--label=org.opencontainers.image.source={{ .GitURL }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"
      - "--label=org.opencontainers.image.created={{ .Date }}"

    extra_files:
      - README.md
      - LICENSE
      - entrypoint.sh
      - default_files/

# GitHub Release é…ç½®
release:
  github:
    owner: anzhiyu-c
    name: anheyu-app

  # Release åç§°
  name_template: "Anheyu App {{ .Tag }}"

  # å‘å¸ƒæ¨¡å¼
  mode: replace

  # é¢„å‘å¸ƒæ£€æµ‹
  prerelease: auto

  # Release Notes æ¨¡æ¿
  header: |
    ## Anheyu App {{ .Tag }}

    ğŸ‰ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼**

    ### ğŸ“‹ æ„å»ºä¿¡æ¯
    - **ç‰ˆæœ¬**: `{{ .Tag }}`
    - **Commit**: [`{{ .ShortCommit }}`](https://github.com/anzhiyu-c/anheyu-app/commit/{{ .FullCommit }})
    - **æ„å»ºæ—¶é—´**: `{{ .Date }}`
    - **Go ç‰ˆæœ¬**: `{{ .Env.GOVERSION }}`

    ### ğŸ“¦ ä¸‹è½½

    é€šè¿‡ [GitHub Releases](https://github.com/anzhiyu-c/anheyu-app/releases/tag/{{ .Tag }}) ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š

    - **Linux AMD64**: `anheyu-app_{{ .Tag }}_linux_amd64.tar.gz`
    - **Linux ARM64**: `anheyu-app_{{ .Tag }}_linux_arm64.tar.gz`  
    - **macOS AMD64**: `anheyu-app_{{ .Tag }}_darwin_amd64.tar.gz`
    - **macOS ARM64**: `anheyu-app_{{ .Tag }}_darwin_arm64.tar.gz`
    - **Windows AMD64**: `anheyu-app_{{ .Tag }}_windows_amd64.zip`

    ### ğŸ³ Docker é•œåƒ
    ```bash
    # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
    docker pull anheyu/anheyu-backend:{{ if eq (substr .Tag 0 1) "v" }}{{ substr .Tag 1 }}{{ else }}{{ .Tag }}{{ end }}
    docker pull anheyu/anheyu-backend:latest

    # å¤šæ¶æ„æ”¯æŒè‡ªåŠ¨é€‰æ‹©
    ```

    ### ğŸš€ å¿«é€Ÿå¼€å§‹
    ```bash
    # ä¸‹è½½å¹¶è¿è¡Œ
    wget https://github.com/anzhiyu-c/anheyu-app/releases/download/{{ .Tag }}/anheyu-app_{{ .Tag }}_linux_amd64.tar.gz
    tar -xzf anheyu-app_{{ .Tag }}_linux_amd64.tar.gz
    ./anheyu-app

    # æˆ–ä½¿ç”¨ Docker
    docker run -d -p 8091:8091 anheyu/anheyu-backend:{{ if eq (substr .Tag 0 1) "v" }}{{ substr .Tag 1 }}{{ else }}{{ .Tag }}{{ end }}
    ```

  footer: |
    ---

    ### ğŸ“š ç›¸å…³é“¾æ¥
    - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/anzhiyu-c/anheyu-app/releases)
    - [æ–‡æ¡£](https://github.com/anzhiyu-c/anheyu-app/blob/main/README.md)
    - [é—®é¢˜åé¦ˆ](https://github.com/anzhiyu-c/anheyu-app/issues)

    **å®Œæ•´çš„ SHA256 æ ¡éªŒå’Œ**ï¼š[anheyu-app_{{ .Tag }}_checksums.txt](https://github.com/anzhiyu-c/anheyu-app/releases/download/{{ .Tag }}/anheyu-app_{{ .Tag }}_checksums.txt)

# å…¬å‘Šé…ç½®
announce:
  skip: "{{gt .Patch 0}}" # è·³è¿‡ patch ç‰ˆæœ¬çš„å…¬å‘Š
